name: SonarCloud Analysis

on:
  push:
    branches:
      - main
      - master
      - dev
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - main
      - master
      - dev
  workflow_dispatch:

jobs:
  sonarcloud:
    name: SonarCloud Monorepo Analysis
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Shallow clones should be disabled for better analysis

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      - name: Cache SonarCloud packages
        uses: actions/cache@v4
        with:
          path: ~/.sonar/cache
          key: ${{ runner.os }}-sonar
          restore-keys: ${{ runner.os }}-sonar

      - name: Cache Maven packages
        uses: actions/cache@v4
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-m2

      # Build all backend services first
      - name: Build User Service
        env:
          JWT_SECRET: test-jwt-secret-for-github-actions-analysis-only-do-not-use-in-production-12345678901234567890
        working-directory: Backend/user-service
        run: |
          echo "ðŸ”¨ Building User Service..."
          ./mvnw -B clean compile test-compile
          ./mvnw -B test || true
          ./mvnw -B package -DskipTests

      - name: Build Product Service
        env:
          JWT_SECRET: test-jwt-secret-for-github-actions-analysis-only-do-not-use-in-production-12345678901234567890
        working-directory: Backend/product-service
        run: |
          echo "ðŸ”¨ Building Product Service..."
          ./mvnw -B clean compile test-compile
          ./mvnw -B test || true
          ./mvnw -B package -DskipTests

      - name: Build Media Service
        env:
          JWT_SECRET: test-jwt-secret-for-github-actions-analysis-only-do-not-use-in-production-12345678901234567890
        working-directory: Backend/media-service
        run: |
          echo "ðŸ”¨ Building Media Service..."
          ./mvnw -B clean compile test-compile
          ./mvnw -B test || true
          ./mvnw -B package -DskipTests

      - name: Build API Gateway
        env:
          JWT_SECRET: test-jwt-secret-for-github-actions-analysis-only-do-not-use-in-production-12345678901234567890
        working-directory: Backend/api-gateway
        run: |
          echo "ðŸ”¨ Building API Gateway..."
          ./mvnw -B clean compile test-compile
          ./mvnw -B test || true
          ./mvnw -B package -DskipTests

      # Build Frontend
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: Frontend/package-lock.json

      - name: Install Frontend dependencies
        working-directory: Frontend
        run: npm ci

      - name: Build Frontend
        working-directory: Frontend
        run: npm run build -- --configuration=production || true
        continue-on-error: true

      # Create consolidated sonar-project.properties for monorepo
      - name: Create Monorepo SonarCloud Configuration
        run: |
          cat > sonar-project.properties << 'EOF'
          # SonarCloud Configuration for Buy01 Monorepo
          sonar.projectKey=buy-01
          sonar.projectName=Buy01 E-Commerce Platform
          sonar.projectVersion=1.0
          
          # Source directories - include all backend services and frontend
          sonar.sources=Backend/user-service/src/main/java,Backend/product-service/src/main/java,Backend/media-service/src/main/java,Backend/api-gateway/src/main/java,Frontend/src
          
          # Test directories
          sonar.tests=Backend/user-service/src/test/java,Backend/product-service/src/test/java,Backend/media-service/src/test/java,Backend/api-gateway/src/test/java
          
          # Java binaries for all services
          sonar.java.binaries=Backend/user-service/target/classes,Backend/product-service/target/classes,Backend/media-service/target/classes,Backend/api-gateway/target/classes
          
          sonar.java.test.binaries=Backend/user-service/target/test-classes,Backend/product-service/target/test-classes,Backend/media-service/target/test-classes,Backend/api-gateway/target/test-classes
          
          # Coverage reports
          sonar.coverage.jacoco.xmlReportPaths=Backend/user-service/target/site/jacoco/jacoco.xml,Backend/product-service/target/site/jacoco/jacoco.xml,Backend/media-service/target/site/jacoco/jacoco.xml,Backend/api-gateway/target/site/jacoco/jacoco.xml
          
          # Test reports
          sonar.junit.reportPaths=Backend/user-service/target/surefire-reports,Backend/product-service/target/surefire-reports,Backend/media-service/target/surefire-reports,Backend/api-gateway/target/surefire-reports
          
          # Encoding
          sonar.sourceEncoding=UTF-8
          
          # Language settings
          sonar.java.source=17
          sonar.java.target=17
          
          # Frontend TypeScript/JavaScript settings
          sonar.typescript.tsconfigPaths=Frontend/tsconfig.json,Frontend/tsconfig.app.json
          sonar.javascript.node.maxspace=4096
          
          # Exclusions
          sonar.exclusions=**/target/**,**/node_modules/**,**/*.xml,**/dist/**,**/.angular/**,**/certs/**
          
          sonar.test.exclusions=**/target/**,**/node_modules/**
          
          # Coverage exclusions (DTOs, configs, main classes)
          sonar.coverage.exclusions=**/dto/**,**/config/**,**/ServiceUserApplication.java,**/ProductServiceApplication.java,**/MediaServiceApplication.java,**/GatewayApplication.java,**/main.ts
          
          # Module organization for better visualization
          sonar.modules=user-service,product-service,media-service,api-gateway,frontend
          
          # User Service module
          user-service.sonar.projectName=User Service
          user-service.sonar.projectBaseDir=Backend/user-service
          user-service.sonar.sources=src/main/java
          user-service.sonar.tests=src/test/java
          user-service.sonar.java.binaries=target/classes
          
          # Product Service module
          product-service.sonar.projectName=Product Service
          product-service.sonar.projectBaseDir=Backend/product-service
          product-service.sonar.sources=src/main/java
          product-service.sonar.tests=src/test/java
          product-service.sonar.java.binaries=target/classes
          
          # Media Service module
          media-service.sonar.projectName=Media Service
          media-service.sonar.projectBaseDir=Backend/media-service
          media-service.sonar.sources=src/main/java
          media-service.sonar.tests=src/test/java
          media-service.sonar.java.binaries=target/classes
          
          # API Gateway module
          api-gateway.sonar.projectName=API Gateway
          api-gateway.sonar.projectBaseDir=Backend/api-gateway
          api-gateway.sonar.sources=src/main/java
          api-gateway.sonar.tests=src/test/java
          api-gateway.sonar.java.binaries=target/classes
          
          # Frontend module
          frontend.sonar.projectName=Frontend
          frontend.sonar.projectBaseDir=Frontend
          frontend.sonar.sources=src
          frontend.sonar.exclusions=**/node_modules/**,**/dist/**,**/.angular/**
          EOF

      # Run SonarCloud analysis for entire monorepo
      - name: SonarCloud Scan (Monorepo)
        uses: SonarSource/sonarcloud-github-action@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          args: >
            -Dsonar.organization=${{ secrets.SONAR_ORGANIZATION }}
            -Dsonar.projectKey=buy-01
            -Dsonar.verbose=true

      - name: Summary
        if: always()
        run: |
          echo "âœ… SonarCloud analysis completed for entire monorepo"
          echo ""
          echo "ðŸ“Š Analyzed Components:"
          echo "  âœ“ Backend/user-service (Java)"
          echo "  âœ“ Backend/product-service (Java)"
          echo "  âœ“ Backend/media-service (Java)"
          echo "  âœ“ Backend/api-gateway (Java)"
          echo "  âœ“ Frontend (TypeScript/Angular)"
          echo ""
          echo "ðŸ”— View results: https://sonarcloud.io/project/overview?id=buy-01"
          echo ""
          echo "ðŸ“ˆ Metrics available:"
          echo "  - Code coverage per service"
          echo "  - Code smells and technical debt"
          echo "  - Security vulnerabilities"
          echo "  - Bugs and reliability issues"

