name: SonarCloud Analysis

on:
  push:
    branches:
      - main
      - master
      - dev
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - main
      - master
      - dev
  workflow_dispatch:

jobs:
  sonarcloud:
    name: SonarCloud Monorepo Analysis
    runs-on: ubuntu-latest

    steps:
      # Security: Pinned to commit SHA to prevent supply chain attacks
      # Version: v4.2.2 - Update by changing SHA and version comment
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0  # Shallow clones should be disabled for better analysis

      # Security: Pinned to commit SHA to prevent supply chain attacks
      # Version: v4.5.0
      - name: Set up JDK 17
        uses: actions/setup-java@8df1039502a15bceb9433410b1a100fbe190c53b # v4.5.0
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      # Security: Pinned to commit SHA v4.2.0
      - name: Cache SonarCloud packages
        uses: actions/cache@1bd1e32a3bdc45362d1e726936510720a7c30a57 # v4.2.0
        with:
          path: ~/.sonar/cache
          key: ${{ runner.os }}-sonar
          restore-keys: ${{ runner.os }}-sonar

      # Security: Pinned to commit SHA v4.2.0
      - name: Cache Maven packages
        uses: actions/cache@1bd1e32a3bdc45362d1e726936510720a7c30a57 # v4.2.0
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-m2

      # Build all backend services first
      - name: Build User Service
        env:
          JWT_SECRET: test-jwt-secret-for-github-actions-analysis-only-do-not-use-in-production-12345678901234567890
        working-directory: Backend/user-service
        run: |
          echo "ðŸ”¨ Building User Service..."
          ./mvnw -B clean compile test-compile
          ./mvnw -B test || true
          ./mvnw -B package -DskipTests

      - name: Build Product Service
        env:
          JWT_SECRET: test-jwt-secret-for-github-actions-analysis-only-do-not-use-in-production-12345678901234567890
        working-directory: Backend/product-service
        run: |
          echo "ðŸ”¨ Building Product Service..."
          ./mvnw -B clean compile test-compile
          ./mvnw -B test || true
          ./mvnw -B package -DskipTests

      - name: Build Media Service
        env:
          JWT_SECRET: test-jwt-secret-for-github-actions-analysis-only-do-not-use-in-production-12345678901234567890
        working-directory: Backend/media-service
        run: |
          echo "ðŸ”¨ Building Media Service..."
          ./mvnw -B clean compile test-compile
          ./mvnw -B test || true
          ./mvnw -B package -DskipTests

      - name: Build API Gateway
        env:
          JWT_SECRET: test-jwt-secret-for-github-actions-analysis-only-do-not-use-in-production-12345678901234567890
        working-directory: Backend/api-gateway
        run: |
          echo "ðŸ”¨ Building API Gateway..."
          ./mvnw -B clean compile test-compile
          ./mvnw -B test || true
          ./mvnw -B package -DskipTests

      # Build Frontend
      # Security: Pinned to commit SHA v4.1.0
      - name: Set up Node.js
        uses: actions/setup-node@39370e3970a6d050c480ffad4ff0ed4d3fdee5af # v4.1.0
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: Frontend/package-lock.json

      # Security: Using --ignore-scripts to prevent execution of potentially malicious scripts during package installation
      - name: Install Frontend dependencies
        working-directory: Frontend
        run: npm ci --ignore-scripts

      - name: Run Frontend Tests with Coverage
        working-directory: Frontend
        run: npm run test:coverage || true
        continue-on-error: true

      - name: Build Frontend
        working-directory: Frontend
        run: npm run build -- --configuration=production || true
        continue-on-error: true

      # Verify SonarCloud Configuration (now committed to repository)
      - name: Verify SonarCloud Configuration
        run: |
          echo "âœ… Using committed sonar-project.properties from repository"
          if [ ! -f "sonar-project.properties" ]; then
            echo "âŒ ERROR: sonar-project.properties not found!"
            exit 1
          fi

      - name: Display SonarCloud Configuration
        run: |
          echo "ðŸ“„ Generated SonarCloud Configuration:"
          echo "========================================"
          cat sonar-project.properties
          echo "========================================"

      # Run SonarCloud analysis for entire monorepo
      # Security: Pinned to commit SHA v5.0.0
      # Configuration is loaded from sonar-project.properties in repository root
      - name: SonarCloud Scan (Monorepo)
        uses: SonarSource/sonarqube-scan-action@0303d6b62e310685c0e34d0b9cde218036885c4d # v5.0.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: https://sonarcloud.io
        with:
          args: >
            -Dsonar.verbose=true

      # Check the Quality Gate status
      # Security: Pinned to commit SHA v1.1.0
      - name: SonarCloud Quality Gate Check
        uses: SonarSource/sonarqube-quality-gate-action@d304d050d930b02a896b0f85935344f023928496 # v1.1.0
        timeout-minutes: 5
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: https://sonarcloud.io
        continue-on-error: true

      - name: Summary
        if: always()
        run: |
          echo "âœ… SonarCloud analysis completed for entire monorepo"
          echo ""
          echo "ðŸ“Š Analyzed Components:"
          echo "  âœ“ Backend/user-service (Java)"
          echo "  âœ“ Backend/product-service (Java)"
          echo "  âœ“ Backend/media-service (Java)"
          echo "  âœ“ Backend/api-gateway (Java)"
          echo "  âœ“ Frontend (TypeScript/Angular)"
          echo ""
          echo "ðŸ”— View results: https://sonarcloud.io/project/overview?id=ToniKorhonen_buy-01"
          echo ""
          echo "ðŸ“ˆ Metrics available:"
          echo "  - Code coverage per service"
          echo "  - Code smells and technical debt"
          echo "  - Security vulnerabilities"
          echo "  - Bugs and reliability issues"

